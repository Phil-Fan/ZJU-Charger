name: Fetch Charger Status

on:
  # 手动触发
  workflow_dispatch:
  
  # 定时触发：每30分钟
  schedule:
    - cron: '*/30 * * * *'

jobs:
  fetch:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      
      - name: Install dependencies
        run: |
          pip install httpx
      
      - name: Fetch and save data
        env:
          API_URL: ${{ secrets.API_URL }}
        run: |
          echo "Calling API: $API_URL/api/fetch-and-save"
          response=$(curl -X POST "$API_URL/api/fetch-and-save" -H "Content-Type: application/json" -w "\n%{http_code}")
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')
          
          if [ "$http_code" -eq 200 ]; then
            echo "API call successful"
            echo "$body" | python3 -m json.tool > /dev/null && echo "Response is valid JSON"
          else
            echo "API call failed with status code: $http_code"
            echo "Response: $body"
            exit 1
          fi
      
      - name: Download latest.json
        env:
          API_URL: ${{ secrets.API_URL }}
        run: |
          curl -o data/latest.json "$API_URL/api/cache" || exit 1
      
      - name: Commit changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add data/latest.json
          git diff --staged --quiet || git commit -m "Update charger status [skip ci]"
          git push
